event.load("player_join");
event.load("player_quit");

databank.workerExecute(databank.prepare("
	CREATE TABLE IF NOT EXISTS playtime (
		id INT NOT NULL AUTO_INCREMENT PRIMARY KEY, 
		player_id INT NOT NULL, 
		join_time BIGINT NOT NULL, 
		leave_time BIGINT
	);
"));

msg.string("dev", "§bPlaytime §rloaded.");
@wait
wait();
player_id = player.getId(player);
ignoreGoto(event);
goto("wait");

@player_join
deleteDefectPlaytime(player_id);
insertPlaytimeJoin(player_id);
goto("wait");

@player_quit
insertPlaytimeLeave(player_id);
goto("wait");

function deleteDefectPlaytime(player_id) {
	stmt = databank.prepare("DELETE FROM playtime WHERE player_id = ? AND leave_time IS NULL;", false);
	databank.setInt(stmt, 1, player_id);
	databank.workerExecute(stmt);
}

function insertPlaytimeJoin(player_id) {
	stmt = databank.prepare("INSERT INTO playtime (player_id, join_time) VALUES (?, ?);", false);
	databank.setInt(stmt, 1, player_id);
	databank.setLong(stmt, 2, time.getMillis());
	databank.workerExecute(stmt);
}

function insertPlaytimeLeave(player_id) {
	stmt = databank.prepare("UPDATE playtime SET leave_time = ? WHERE player_id = ? AND leave_time IS NULL;", false);
	databank.setLong(stmt, 1, time.getMillis());
	databank.setInt(stmt, 2, player_id);
	databank.workerExecute(stmt);
}